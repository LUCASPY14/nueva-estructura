{% extends 'dashboard_base.html' %}
{% block title %}Validar Transacci√≥n{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <div class="bg-white p-6 shadow rounded">
        <h1 class="text-2xl font-bold mb-6">‚úÖ Validar Transacci√≥n #{{ transaccion.id }}</h1>
        
        <div class="mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <p class="text-gray-500 text-sm">Alumno:</p>
              <p class="font-medium">{{ transaccion.alumno.nombre }} {{ transaccion.alumno.apellido }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Monto:</p>
              <p class="font-medium">{{ transaccion.monto|floatformat:0 }} Gs.</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">M√©todo de pago:</p>
              <p class="font-medium">{{ transaccion.get_metodo_pago_display }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Referencia:</p>
              <p class="font-medium">{{ transaccion.referencia_pago|default:"-" }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Fecha y hora:</p>
              <p class="font-medium">{{ transaccion.fecha_hora|date:"d/m/Y H:i" }}</p>
            </div>
            <div>
              <p class="text-gray-500 text-sm">Solicitado por:</p>
              <p class="font-medium">{{ transaccion.realizada_por.get_full_name|default:transaccion.realizada_por.username }}</p>
            </div>
          </div>
          
          {% if transaccion.notas %}
          <div class="bg-gray-50 p-4 rounded mb-6">
            <p class="text-gray-500 text-sm mb-1">Notas del solicitante:</p>
            <p>{{ transaccion.notas|linebreaks }}</p>
          </div>
          {% endif %}
          
          <form method="post">
            {% csrf_token %}
            
            <div class="mb-4">
              <p class="block text-gray-700 font-medium mb-2">Acci√≥n a realizar:</p>
              <div class="space-y-2 bg-gray-50 p-4 rounded border">
                {% for radio in form.accion %}
                <div>
                  {{ radio.tag }}
                  <label for="{{ radio.id_for_label }}" class="ml-2">{{ radio.choice_label }}</label>
                </div>
                {% endfor %}
              </div>
              {% if form.accion.errors %}
              <p class="text-red-500 text-sm mt-1">{{ form.accion.errors.0 }}</p>
              {% endif %}
            </div>
            
            <div class="mb-4" id="motivo-rechazo-container">
              <label class="block text-gray-700 mb-2" for="{{ form.motivo_rechazo.id_for_label }}">Motivo del rechazo:</label>
              {{ form.motivo_rechazo }}
              <p class="text-gray-500 text-sm mt-1">{{ form.motivo_rechazo.help_text }}</p>
              {% if form.motivo_rechazo.errors %}
              <p class="text-red-500 text-sm mt-1">{{ form.motivo_rechazo.errors.0 }}</p>
              {% endif %}
            </div>
            
            <div class="flex justify-between mt-6">
              <a href="{% url 'alumnos:transacciones_lista' %}" class="text-gray-600 hover:underline">‚Üê Volver a la lista</a>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Procesar Transacci√≥n</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="lg:col-span-1">
      {% if transaccion.comprobante %}
      <div class="bg-white p-6 shadow rounded mb-6">
        <h2 class="text-lg font-semibold mb-3">üìÑ Comprobante</h2>
        <div class="text-center">
          <a href="{{ transaccion.comprobante.url }}" target="_blank" class="block">
            <img src="{{ transaccion.comprobante.url }}" alt="Comprobante" class="max-w-full h-auto mx-auto rounded border">
          </a>
          <a href="{{ transaccion.comprobante.url }}" target="_blank" class="text-blue-600 hover:underline mt-2 inline-block">
            Ver tama√±o completo
          </a>
        </div>
      </div>
      {% else %}
      <div class="bg-white p-6 shadow rounded mb-6">
        <h2 class="text-lg font-semibold mb-3">üìÑ Comprobante</h2>
        <p class="text-center text-gray-500 italic">No se adjunt√≥ comprobante</p>
      </div>
      {% endif %}
      
      <div class="bg-white p-6 shadow rounded">
        <h2 class="text-lg font-semibold mb-3">üìä Informaci√≥n del Alumno</h2>
        <div class="space-y-3">
          <p><strong>Nombre:</strong> {{ transaccion.alumno.nombre }} {{ transaccion.alumno.apellido }}</p>
          <p><strong>Tarjeta:</strong> {{ transaccion.alumno.numero_tarjeta|default:"No asignada" }}</p>
          <p><strong>Saldo actual:</strong> {{ transaccion.alumno.saldo_tarjeta|floatformat:0 }} Gs.</p>
          <hr class="my-3">
          <p><strong>Saldo despu√©s de aprobar:</strong> <span class="text-green-600 font-bold">{{ transaccion.alumno.saldo_tarjeta|add:transaccion.monto|floatformat:0 }} Gs.</span></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[name="accion"]');
    const motivoContainer = document.getElementById('motivo-rechazo-container');
    
    function updateVisibility() {
      const selected = document.querySelector('input[name="accion"]:checked').value;
      motivoContainer.style.display = selected === 'rechazar' ? 'block' : 'none';
    }
    
    radioButtons.forEach(function(radio) {
      radio.addEventListener('change', updateVisibility);
    });
    
    // Inicializar
    updateVisibility();
  });
</script>
{% endblock %}