{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    .comprobante-thumbnail {
        max-width: 60px;
        max-height: 60px;
        object-fit: cover;
        cursor: pointer;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }
    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
        max-height: 80%;
        object-fit: contain;
    }
    .modal-content, .close {
        animation: zoom 0.6s;
    }
    @keyframes zoom {
        from {transform:scale(0)}
        to {transform:scale(1)}
    }
    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">{{ titulo }}</h1>
                <p class="text-gray-600 mt-1">Gestionar solicitudes de recarga de saldo pendientes</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-sm text-gray-600">Solicitudes pendientes</p>
                    <p class="text-2xl font-bold text-yellow-600">{{ solicitudes|length }}</p>
                </div>
                <a href="{% url 'alumnos:dashboard_saldo' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros rápidos -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-0">
                <input type="text" id="searchInput" placeholder="Buscar por alumno, padre o referencia..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex space-x-2">
                <select id="filtroMetodo" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos los métodos</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="deposito">Depósito</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="cheque">Cheque</option>
                </select>
                <select id="filtroMonto" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos los montos</option>
                    <option value="0-50000">Hasta $50.000</option>
                    <option value="50000-100000">$50.000 - $100.000</option>
                    <option value="100000-500000">$100.000 - $500.000</option>
                    <option value="500000+">Más de $500.000</option>
                </select>
            </div>
        </div>
    </div>

    {% if solicitudes %}
        <!-- Lista de Solicitudes -->
        <div class="space-y-4">
            {% for solicitud in solicitudes %}
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden solicitud-card" 
                     data-alumno="{{ solicitud.alumno.get_nombre_completo|lower }}"
                     data-padre="{{ solicitud.padre_solicitante.get_full_name|lower }}"
                     data-referencia="{{ solicitud.referencia_pago|lower }}"
                     data-metodo="{{ solicitud.metodo_pago }}"
                     data-monto="{{ solicitud.monto_solicitado }}">
                    
                    <div class="p-6">
                        <div class="flex items-start justify-between">
                            <!-- Información principal -->
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">{{ solicitud.alumno.get_nombre_completo }}</h3>
                                        <p class="text-sm text-gray-600">
                                            Solicitado por: {{ solicitud.padre_solicitante.get_full_name }}
                                            {% if solicitud.padre_solicitante.email %}
                                                ({{ solicitud.padre_solicitante.email }})
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>

                                <!-- Detalles de la solicitud -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-xs text-gray-600 uppercase tracking-wide">Monto Solicitado</p>
                                        <p class="text-xl font-bold text-green-600">${{ solicitud.monto_solicitado|floatformat:0 }}</p>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-xs text-gray-600 uppercase tracking-wide">Método de Pago</p>
                                        <p class="text-sm font-medium">{{ solicitud.get_metodo_pago_display }}</p>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <p class="text-xs text-gray-600 uppercase tracking-wide">Saldo Actual</p>
                                        <p class="text-sm font-medium">{{ solicitud.alumno.get_saldo_formateado }}</p>
                                    </div>
                                </div>

                                <!-- Información adicional -->
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Fecha de solicitud:</span>
                                        <span class="font-medium">{{ solicitud.fecha_solicitud|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% if solicitud.referencia_pago %}
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Referencia:</span>
                                        <span class="font-medium">{{ solicitud.referencia_pago }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Curso:</span>
                                        <span class="font-medium">{{ solicitud.alumno.curso|default:"No asignado" }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Comprobante y acciones -->
                            <div class="flex-shrink-0 ml-6">
                                <div class="text-center space-y-4">
                                    <!-- Comprobante -->
                                    {% if solicitud.comprobante %}
                                        <div class="mb-4">
                                            <p class="text-xs text-gray-600 mb-2">Comprobante</p>
                                            {% if ".pdf" in solicitud.comprobante.url %}
                                                <a href="{{ solicitud.comprobante.url }}" target="_blank" 
                                                   class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-lg border-2 border-dashed border-red-300 hover:border-red-400 transition-colors">
                                                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                    </svg>
                                                </a>
                                            {% else %}
                                                <img src="{{ solicitud.comprobante.url }}" 
                                                     alt="Comprobante" 
                                                     class="comprobante-thumbnail rounded-lg border-2 border-gray-200 hover:border-blue-400 transition-colors"
                                                     onclick="openModal(this.src)">
                                            {% endif %}
                                        </div>
                                    {% endif %}

                                    <!-- Botones de acción -->
                                    <div class="space-y-2">
                                        <a href="{% url 'alumnos:procesar_solicitud' solicitud.id %}" 
                                           class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                            </svg>
                                            Procesar
                                        </a>
                                        
                                        <button onclick="quickApprove({{ solicitud.id }}, '{{ solicitud.alumno.get_nombre_completo }}', {{ solicitud.monto_solicitado }})"
                                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-green-300 rounded-md shadow-sm text-sm font-medium text-green-700 bg-green-50 hover:bg-green-100 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                            </svg>
                                            Aprobar Rápido
                                        </button>

                                        <button onclick="quickReject({{ solicitud.id }}, '{{ solicitud.alumno.get_nombre_completo }}')"
                                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                            Rechazar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información del alumno expandible -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="toggleAlumnoInfo('alumno-{{ solicitud.id }}')" 
                                    class="flex items-center text-sm text-gray-600 hover:text-gray-900">
                                <svg class="w-4 h-4 mr-2 transform transition-transform" id="icon-alumno-{{ solicitud.id }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                Ver más información del alumno
                            </button>
                            
                            <div id="alumno-{{ solicitud.id }}" class="hidden mt-3 p-4 bg-blue-50 rounded-lg">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600">Número de matrícula:</p>
                                        <p class="font-medium">{{ solicitud.alumno.numero_matricula }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Número de tarjeta:</p>
                                        <p class="font-medium">{{ solicitud.alumno.numero_tarjeta|default:"No asignado" }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Límite de consumo diario:</p>
                                        <p class="font-medium">
                                            {% if solicitud.alumno.limite_consumo > 0 %}
                                                ${{ solicitud.alumno.limite_consumo|floatformat:0 }}
                                            {% else %}
                                                Sin límite
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Consumo de hoy:</p>
                                        <p class="font-medium">${{ solicitud.alumno.consumo_diario|floatformat:0 }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Estado vacío -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No hay solicitudes pendientes</h3>
            <p class="text-gray-600 mb-6">
                Todas las solicitudes han sido procesadas. ¡Excelente trabajo!
            </p>
            <a href="{% url 'alumnos:dashboard_saldo' %}" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Ver Dashboard
            </a>
        </div>
    {% endif %}
</div>

<!-- Modal para ver imágenes -->
<div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImg">
</div>

<!-- Modal de confirmación para aprobación rápida -->
<div id="quickApproveModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Aprobar Solicitud</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="approveMessage"></p>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto a aprobar:</label>
                    <input type="number" id="approveAmount" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" step="1000" min="1000">
                </div>
            </div>
            <div class="flex justify-center space-x-4 px-4 py-3">
                <button id="confirmApprove" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Aprobar
                </button>
                <button onclick="closeQuickApproveModal()" class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para rechazo rápido -->
<div id="quickRejectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Rechazar Solicitud</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="rejectMessage"></p>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo del rechazo:</label>
                    <textarea id="rejectReason" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Explique el motivo del rechazo..."></textarea>
                </div>
            </div>
            <div class="flex justify-center space-x-4 px-4 py-3">
                <button id="confirmReject" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Rechazar
                </button>
                <button onclick="closeQuickRejectModal()" class="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales para modales
let currentSolicitudId = null;

// Filtros de búsqueda
document.getElementById('searchInput').addEventListener('input', filterSolicitudes);
document.getElementById('filtroMetodo').addEventListener('change', filterSolicitudes);
document.getElementById('filtroMonto').addEventListener('change', filterSolicitudes);

function filterSolicitudes() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const metodoFilter = document.getElementById('filtroMetodo').value;
    const montoFilter = document.getElementById('filtroMonto').value;
    
    const solicitudes = document.querySelectorAll('.solicitud-card');
    
    solicitudes.forEach(card => {
        let show = true;
        
        // Filtro de texto
        if (searchTerm) {
            const alumno = card.dataset.alumno;
            const padre = card.dataset.padre;
            const referencia = card.dataset.referencia;
            
            if (!alumno.includes(searchTerm) && !padre.includes(searchTerm) && !referencia.includes(searchTerm)) {
                show = false;
            }
        }
        
        // Filtro de método
        if (metodoFilter && card.dataset.metodo !== metodoFilter) {
            show = false;
        }
        
        // Filtro de monto
        if (montoFilter) {
            const monto = parseFloat(card.dataset.monto);
            switch(montoFilter) {
                case '0-50000':
                    if (monto > 50000) show = false;
                    break;
                case '50000-100000':
                    if (monto <= 50000 || monto > 100000) show = false;
                    break;
                case '100000-500000':
                    if (monto <= 100000 || monto > 500000) show = false;
                    break;
                case '500000+':
                    if (monto <= 500000) show = false;
                    break;
            }
        }
        
        card.style.display = show ? 'block' : 'none';
    });
}

// Modal de imágenes
function openModal(src) {
    document.getElementById('imageModal').style.display = 'block';
    document.getElementById('modalImg').src = src;
}

function closeModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera de la imagen
document.getElementById('imageModal').onclick = function(event) {
    if (event.target == this) {
        closeModal();
    }
}

// Toggle información del alumno
function toggleAlumnoInfo(id) {
    const element = document.getElementById(id);
    const icon = document.getElementById('icon-' + id);
    
    if (element.classList.contains('hidden')) {
        element.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        element.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Modal de aprobación rápida
function quickApprove(solicitudId, alumnoNombre, monto) {
    currentSolicitudId = solicitudId;
    document.getElementById('approveMessage').textContent = 
        `¿Está seguro de aprobar la solicitud de recarga para ${alumnoNombre}?`;
    document.getElementById('approveAmount').value = monto;
    document.getElementById('quickApproveModal').classList.remove('hidden');
}

function closeQuickApproveModal() {
    document.getElementById('quickApproveModal').classList.add('hidden');
    currentSolicitudId = null;
}

// Confirmar aprobación
document.getElementById('confirmApprove').onclick = function() {
    const monto = document.getElementById('approveAmount').value;
    
    if (!monto || monto < 1000) {
        alert('Debe especificar un monto válido (mínimo $1.000)');
        return;
    }
    
    // Crear formulario para enviar
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/alumnos/admin/procesar-solicitud/${currentSolicitudId}/`;
    
    // Token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = 'csrfmiddlewaretoken';
        csrfField.value = csrfToken.value;
        form.appendChild(csrfField);
    }
    
    // Campos del formulario
    const estadoField = document.createElement('input');
    estadoField.type = 'hidden';
    estadoField.name = 'estado';
    estadoField.value = 'aprobada';
    form.appendChild(estadoField);
    
    const montoField = document.createElement('input');
    montoField.type = 'hidden';
    montoField.name = 'monto_aprobado';
    montoField.value = monto;
    form.appendChild(montoField);
    
    const obsField = document.createElement('input');
    obsField.type = 'hidden';
    obsField.name = 'observaciones_admin';
    obsField.value = 'Aprobación rápida desde lista de pendientes';
    form.appendChild(obsField);
    
    document.body.appendChild(form);
    form.submit();
};

// Modal de rechazo rápido
function quickReject(solicitudId, alumnoNombre) {
    currentSolicitudId = solicitudId;
    document.getElementById('rejectMessage').textContent = 
        `¿Está seguro de rechazar la solicitud de recarga para ${alumnoNombre}?`;
    document.getElementById('rejectReason').value = '';
    document.getElementById('quickRejectModal').classList.remove('hidden');
}

function closeQuickRejectModal() {
    document.getElementById('quickRejectModal').classList.add('hidden');
    currentSolicitudId = null;
}

// Confirmar rechazo
document.getElementById('confirmReject').onclick = function() {
    const motivo = document.getElementById('rejectReason').value.trim();
    
    if (!motivo) {
        alert('Debe especificar un motivo para el rechazo');
        return;
    }
    
    // Crear formulario para enviar
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/alumnos/admin/procesar-solicitud/${currentSolicitudId}/`;
    
    // Token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = 'csrfmiddlewaretoken';
        csrfField.value = csrfToken.value;
        form.appendChild(csrfField);
    }
    
    // Campos del formulario
    const estadoField = document.createElement('input');
    estadoField.type = 'hidden';
    estadoField.name = 'estado';
    estadoField.value = 'rechazada';
    form.appendChild(estadoField);
    
    const obsField = document.createElement('input');
    obsField.type = 'hidden';
    obsField.name = 'observaciones_admin';
    obsField.value = motivo;
    form.appendChild(obsField);
    
    document.body.appendChild(form);
    form.submit();
};

// Cerrar modales con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeQuickApproveModal();
        closeQuickRejectModal();
    }
});
</script>
{% endblock %}